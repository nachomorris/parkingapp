<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard — Gestor de Estacionamiento</title>

  <!-- Estética igual a la app (Arial + gradiente + acentos coral) -->
  <style>
    :root{
      --grad-a:#f6d365;
      --grad-b:#fda085;
      --panel:#ffffff;
      --panel-soft:#fff5f0;
      --accent:#fda085;
      --accent-2:#f6d365;
      --ink:#333;
      --muted:#666;
      --border-soft:#ffe3d8;
      --danger:#e74c3c;
    }

    *{margin:0;padding:0;box-sizing:border-box;font-family:Arial, sans-serif}

    body{
      min-height:100vh;
      background: linear-gradient(135deg, var(--grad-a) 0%, var(--grad-b) 100%);
      display:flex; align-items:center; justify-content:center;
      padding:10px;
      color:var(--ink);
    }

    .container{
      width:100%; max-width:1100px; min-height:80vh;
      background:var(--panel);
      border-radius:15px;
      box-shadow:0 10px 30px rgba(0,0,0,.2);
      overflow:hidden;
      display:flex; flex-direction:column;
    }

    .header{
      background:var(--panel-soft);
      border-bottom:2px solid var(--accent);
      padding:16px 20px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      flex-wrap:wrap;
    }
    .title{
      font-size:1.2rem; font-weight:700; color:var(--ink);
    }

    .filters{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .filters input[type="date"]{
      padding:8px 10px; border:2px solid #ddd; border-radius:8px; font-size:14px; background:#fff; color:var(--ink);
    }
    .btn{
      padding:10px 12px; border:none; border-radius:8px; cursor:pointer; font-weight:700; color:#fff; background:var(--accent);
    }
    .btn:hover{ background:var(--accent-2); }
    .btn-soft{
      background:#fff; color:var(--ink); border:2px solid var(--accent);
    }
    .btn-soft:hover{ background:var(--panel-soft); }

    .content{
      padding:18px; display:flex; flex-direction:column; gap:18px;
      overflow:auto;
    }

    .kpis{
      display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:12px;
    }
    .kpi{
      background:#fff; border:1px solid var(--border-soft); border-radius:12px; padding:14px 16px;
      box-shadow:0 2px 10px rgba(0,0,0,.05);
    }
    .kpi h3{ font-size:.9rem; color:var(--muted); margin-bottom:6px; }
    .kpi .val{ font-size:1.6rem; font-weight:800; color:var(--ink); }

    .grid{
      display:grid; grid-template-columns: 1.2fr .8fr; gap:12px;
    }
    .card{
      background:#fff; border:1px solid var(--border-soft); border-radius:12px; padding:14px 16px;
      box-shadow:0 2px 10px rgba(0,0,0,.05);
    }
    .card h3{ font-size:1rem; margin-bottom:10px; color:var(--ink); }

    .charts{
      display:grid; grid-template-columns:1fr 1fr; gap:12px;
    }
    .chart-box{
      background:#fff; border:1px solid var(--border-soft); border-radius:12px; padding:10px;
      height:300px; display:flex; align-items:center; justify-content:center;
    }
    canvas{ width:100% !important; height:100% !important; }

    .table-wrap{
      overflow:auto; border:1px solid var(--border-soft); border-radius:12px;
    }
    table{ width:100%; border-collapse:collapse; }
    thead th{
      background:var(--panel-soft); color:var(--ink); text-align:left; padding:10px; font-size:.9rem; border-bottom:2px solid var(--border-soft);
      position:sticky; top:0; z-index:1;
    }
    tbody td{ padding:10px; border-bottom:1px solid var(--border-soft); font-size:.9rem; color:var(--ink); }
    tbody tr:hover{ background:#fffaf7; }

    .badge{
      display:inline-block; padding:4px 8px; border-radius:999px; font-weight:700; font-size:.8rem; color:#fff;
      background:var(--accent);
    }

    @media (max-width:900px){
      .grid{ grid-template-columns:1fr; }
      .charts{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header / Filtros -->
    <div class="header">
      <div class="title">Dashboard — Historial</div>
      <div class="filters">
        <input type="date" id="fromDate">
        <input type="date" id="toDate">
        <button class="btn-soft" id="btnHoy">Hoy</button>
        <button class="btn-soft" id="btnMes">Este mes</button>
        <button class="btn" id="btnReset">Todo</button>
      </div>
    </div>

    <!-- Contenido -->
    <div class="content">
      <!-- KPIs -->
      <div class="kpis">
        <div class="kpi">
          <h3>Recaudación (rango)</h3>
          <div class="val" id="kpiRecaudacion">$0</div>
        </div>
        <div class="kpi">
          <h3>Entradas (rango)</h3>
          <div class="val" id="kpiEntradas">0</div>
        </div>
        <div class="kpi">
          <h3>Salidas (rango)</h3>
          <div class="val" id="kpiSalidas">0</div>
        </div>
      </div>

      <!-- Gráficos -->
      <div class="charts">
        <div class="chart-box"><canvas id="chartIngresos"></canvas></div>
        <div class="chart-box"><canvas id="chartVehiculos"></canvas></div>
      </div>

      <!-- Tabla -->
      <div class="card">
        <h3>Historial de operaciones</h3>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Patente</th>
                <th>Tipo</th>
                <th>Entrada</th>
                <th>Salida</th>
                <th>Tiempo</th>
                <th>Total</th>
                <th>Notas</th>
              </tr>
            </thead>
            <tbody id="tbodyHistorial"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase base compartida (tu archivo) -->
  <script type="module">
    import { db } from './firebase.js';
    import {
      ref, onValue
    } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-database.js";

    // ========== Utilidades de fecha ==========
    const fmt = (d)=> new Date(d).toLocaleString([], { dateStyle:'short', timeStyle:'short' });
    const fmtTime = (d)=> new Date(d).toLocaleTimeString([], { hour:'2-digit', minute:'2-digit', hour12:false });
    function ymdLocal(date){
      const d = new Date(date);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const da = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    }
    function parseYMD(s){
      const [y,m,d] = s.split('-').map(Number);
      const dt = new Date(y, m-1, d);
      dt.setHours(0,0,0,0);
      return dt;
    }
    function inRange(dateISO, from, to){
      const t = new Date(dateISO).getTime();
      return (from==null || t>=from) && (to==null || t<=to);
    }
    function formatHM(totalMin){
      const h = Math.floor(totalMin/60);
      const m = totalMin%60;
      if (h<=0) return `${m} min`;
      if (m<=0) return `${h} h`;
      return `${h} h ${m} min`;
    }

    // ========== Estado filtros ==========
    const fromInp = document.getElementById('fromDate');
    const toInp   = document.getElementById('toDate');
    const btnHoy  = document.getElementById('btnHoy');
    const btnMes  = document.getElementById('btnMes');
    const btnReset= document.getElementById('btnReset');

    let range = { from:null, to:null }; // timestamps (ms) o null

    btnHoy.addEventListener('click', ()=>{
      const d = new Date(); d.setHours(0,0,0,0);
      const from = d.getTime();
      const to = from + 24*60*60*1000 - 1;
      range = { from, to };
      fromInp.value = ymdLocal(new Date(from));
      toInp.value   = ymdLocal(new Date(to));
      render();
    });

    btnMes.addEventListener('click', ()=>{
      const d = new Date();
      const first = new Date(d.getFullYear(), d.getMonth(), 1);
      const last  = new Date(d.getFullYear(), d.getMonth()+1, 0, 23,59,59,999);
      range = { from:first.getTime(), to:last.getTime() };
      fromInp.value = ymdLocal(first);
      toInp.value   = ymdLocal(last);
      render();
    });

    btnReset.addEventListener('click', ()=>{
      range = { from:null, to:null };
      fromInp.value = ''; toInp.value = '';
      render();
    });

    fromInp.addEventListener('change', ()=>{
      range.from = fromInp.value ? parseYMD(fromInp.value).getTime() : null;
      render();
    });
    toInp.addEventListener('change', ()=>{
      if (toInp.value){
        const dt = parseYMD(toInp.value);
        dt.setHours(23,59,59,999);
        range.to = dt.getTime();
      } else {
        range.to = null;
      }
      render();
    });

    // ========== Carga de historial ==========
    let HIST = []; // {id, placa, tipo, entradaISO, salidaISO, minutos, total, notas}

    // Soporta /historial plano o bajo días (/historial/2025-10-21/id)
    onValue(ref(db, 'historial'), (snap)=>{
      const val = snap.val() || {};
      const flat = [];

      const maybePush = (obj)=>{
        // validar campos mínimos
        if (!obj) return;
        const { placa, tipo, entradaISO, salidaISO, minutos, total, notas, id } = obj;
        // si falta salidaISO/total igual lo mostramos, pero no suma recaudación
        flat.push({
          id: id || crypto.randomUUID(),
          placa: placa || '',
          tipo:  tipo || '',
          entradaISO: entradaISO || null,
          salidaISO:  salidaISO  || null,
          minutos: Number(minutos||0),
          total: Number(total||0),
          notas: notas || ''
        });
      };

      // detectar si es plano (ids) o por días
      const topKeys = Object.keys(val);
      for (const k of topKeys){
        const node = val[k];
        // si node parece un item (tiene placa/tipo/etc.)
        if (node && (node.placa || node.entradaISO || node.salidaISO)){
          maybePush(node);
        } else if (node && typeof node === 'object') {
          // recorrer hijos (por día)
          for (const id in node){
            maybePush(node[id]);
          }
        }
      }

      // ordenar por salida (o entrada si no hay) desc
      flat.sort((a,b)=>{
        const ta = new Date(a.salidaISO || a.entradaISO || 0).getTime();
        const tb = new Date(b.salidaISO || b.entradaISO || 0).getTime();
        return tb - ta;
      });

      HIST = flat;
      render();
    });

    // ========== Render ==========
    const kRecaud = document.getElementById('kpiRecaudacion');
    const kEntr   = document.getElementById('kpiEntradas');
    const kSal    = document.getElementById('kpiSalidas');
    const tbody   = document.getElementById('tbodyHistorial');

    let chartIngresos, chartVehiculos;

    function numberToMoney(n){
      try{
        return n.toLocaleString('es-AR', { style:'currency', currency:'ARS', maximumFractionDigits:0 });
      }catch{ return '$' + Math.round(n); }
    }

    function render(){
      // filtrar por rango usando FECHA DE SALIDA (si no hay, usa entrada)
      const list = HIST.filter(r=>{
        const when = r.salidaISO || r.entradaISO;
        if (!when) return false;
        return inRange(when, range.from, range.to);
      });

      // KPIs
      const entradas = list.length;  // entradas en rango (por simplicidad)
      const salidas  = list.filter(x=>x.salidaISO).length;
      const recaud   = list.reduce((acc,x)=> acc + (x.salidaISO ? (x.total||0) : 0), 0);

      kRecaud.textContent = numberToMoney(recaud);
      kEntr.textContent   = entradas;
      kSal.textContent    = salidas;

      // Agrupar por día (YYYY-MM-DD de la salida; si no hay salida, usa entrada)
      const perDayCount = {};
      const perDayMoney = {};
      for (const r of list){
        const dkey = ymdLocal(r.salidaISO || r.entradaISO);
        perDayCount[dkey] = (perDayCount[dkey]||0) + 1;
        if (r.salidaISO) perDayMoney[dkey] = (perDayMoney[dkey]||0) + (r.total||0);
      }
      const days = Object.keys(perDayCount).sort();
      const dataCount = days.map(d=> perDayCount[d]||0);
      const dataMoney = days.map(d=> perDayMoney[d]||0);

      // Tabla
      tbody.innerHTML = '';
      for (const r of list){
        const tr = document.createElement('tr');
        const fechaKey = ymdLocal(r.salidaISO || r.entradaISO);
        tr.innerHTML = `
          <td>${fechaKey}</td>
          <td>${r.placa}</td>
          <td><span class="badge">${r.tipo||''}</span></td>
          <td>${r.entradaISO? fmtTime(r.entradaISO): ''}</td>
          <td>${r.salidaISO?  fmtTime(r.salidaISO) : ''}</td>
          <td>${formatHM(Number(r.minutos||0))}</td>
          <td>${r.salidaISO? numberToMoney(Number(r.total||0)) : '-'}</td>
          <td>${r.notas? r.notas : ''}</td>
        `;
        tbody.appendChild(tr);
      }

      // Charts
      drawCharts(days, dataMoney, dataCount);
    }

    // ========== Charts (Chart.js CDN) ==========
    // Cargamos Chart.js dinámicamente para no romper nada si ya lo usás en otro lado
    let chartJsLoaded = false;
    async function ensureChartJs(){
      if (chartJsLoaded) return;
      await new Promise((resolve,reject)=>{
        const s=document.createElement('script');
        s.src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js";
        s.onload=()=>resolve();
        s.onerror=()=>reject(new Error('No se pudo cargar Chart.js'));
        document.head.appendChild(s);
      });
      chartJsLoaded = true;
    }

    async function drawCharts(labels, money, count){
      await ensureChartJs();
      const moneyCtx = document.getElementById('chartIngresos').getContext('2d');
      const countCtx = document.getElementById('chartVehiculos').getContext('2d');

      // destruir si existen
      if (chartIngresos) chartIngresos.destroy();
      if (chartVehiculos) chartVehiculos.destroy();

      // Colores en línea con la app
      const fill = 'rgba(253, 160, 133, 0.35)'; // #fda085 con alpha
      const stroke = '#fda085';
      const stroke2 = '#f6d365';

      chartIngresos = new window.Chart(moneyCtx, {
        type:'bar',
        data:{
          labels,
          datasets:[{
            label:'Recaudación diaria',
            data: money,
            backgroundColor: fill,
            borderColor: stroke,
            borderWidth: 2
          }]
        },
        options:{
          plugins:{ legend:{ display:false } },
          scales:{
            y:{ ticks:{ callback:(v)=> numberToMoney(v) } }
          }
        }
      });

      chartVehiculos = new window.Chart(countCtx, {
        type:'line',
        data:{
          labels,
          datasets:[{
            label:'Vehículos por día',
            data: count,
            borderColor: stroke2,
            backgroundColor: 'rgba(246, 211, 101, 0.25)',
            borderWidth: 2,
            tension:.25,
            fill:true
          }]
        },
        options:{ plugins:{ legend:{ display:false } } }
      });
    }
  </script>
</body>
</html>
