<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestor de Estacionamiento (M√≥vil)</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<script type="module" src="./firebase.js"></script>
<style>
  *{margin:0;padding:0;box-sizing:border-box;font-family:'Roboto',sans-serif;transition:all .3s ease}
  html,body{height:100%;overflow:hidden;background:#f5f5f5;color:#333}
  body{display:flex;flex-direction:column;height:100dvh}

  /* Panel superior fijo */
  .top-panel{
    flex-shrink:0;
    background:#f9f9f9;
    padding:15px;
    border-bottom:2px solid #ddd;
  }
  h2{font-size:1.2em;font-weight:700;margin-bottom:10px}

  input{
    width:100%;padding:10px;margin-bottom:8px;
    border:1px solid #ccc;border-radius:8px;font-size:16px;
  }
  input:focus{outline:none;border-color:#4a90e2;box-shadow:0 0 5px rgba(74,144,226,.4)}

  .vehicle-buttons{display:flex;justify-content:space-between;margin:10px 0}
  .vehicle-btn{
    flex:1;padding:8px;margin:0 4px;border:1px solid #ccc;border-radius:8px;
    font-size:22px;cursor:pointer;background:#fff;
  }
  .vehicle-btn.active{border:3px solid #4a90e2;box-shadow:0 3px 6px rgba(0,0,0,.15)}
  button#btn-entrada{
    width:100%;padding:12px;background:#4a90e2;color:#fff;
    border:none;border-radius:8px;font-size:1.1em;font-weight:700;
  }
  button#btn-entrada:hover{background:#357abd}

  /* Panel inferior scrollable */
  .bottom-panel{
    flex:1;overflow-y:auto;padding:10px;
    background:#fff;
    padding-bottom:clamp(24px,env(safe-area-inset-bottom)+24px,64px);
  }
  .bottom-panel::after{content:"";display:block;height:28px}

  .header-row{
    display:flex;justify-content:space-between;align-items:center;
    margin-bottom:10px;
  }
  .header-row h3{font-size:1.1em;font-weight:700;text-transform:uppercase}
  .count{font-size:1em;font-weight:700;color:#4a90e2}

  #searchInput{
    width:100%;padding:8px;border:1px solid #ccc;border-radius:8px;
    font-size:14px;margin-bottom:8px;
  }
  #searchInput:focus{outline:none;border-color:#4a90e2;box-shadow:0 0 5px rgba(74,144,226,.5)}

  #clearFilterBtn{
    display:none;width:100%;padding:8px;background:#e67e22;color:#fff;
    border:none;border-radius:8px;font-size:13px;margin-bottom:8px;
  }
  #clearFilterBtn.active{display:block}
  #clearFilterBtn:hover{background:#d35400}

  ul{list-style:none}
  li{
    display:flex;justify-content:space-between;align-items:center;
    background:#f9f9f9;border:1px solid #ddd;border-left:4px solid #4a90e2;
    border-radius:8px;padding:8px;margin-bottom:8px;
  }
  .plate{font-size:1.3em;font-weight:700}
  .time{font-size:.8em;color:#666;margin-top:4px;display:block}
  .delete-btn{
    background:#e74c3c;color:#fff;border:none;border-radius:8px;
    padding:6px 12px;font-size:14px;font-weight:700;
  }
  .delete-btn:hover{background:#c0392b}

  /* Toast */
  .toast{
    visibility:hidden;min-width:200px;background:#333;color:#fff;text-align:center;
    border-radius:8px;padding:10px;position:fixed;z-index:1002;left:50%;bottom:20px;
    transform:translateX(-50%);font-size:14px;
  }
  .toast.show{visibility:visible;animation:fadeInOut 2s}
  @keyframes fadeInOut{0%{opacity:0}10%{opacity:1}90%{opacity:1}100%{opacity:0}}
</style>
</head>
<body>
  <div class="top-panel">
    <h2>INGRESO DE VEH√çCULO</h2>
    <input type="text" id="placa" placeholder="Patente" list="placaSuggestions" autocomplete="off">
    <input type="text" id="entryTime" readonly>
    <datalist id="placaSuggestions"></datalist>
    <input type="text" id="notas" placeholder="Notas">
    <div class="vehicle-buttons">
      <button class="vehicle-btn active" data-tipo="auto">üöó</button>
      <button class="vehicle-btn" data-tipo="camioneta">üöê</button>
      <button class="vehicle-btn" data-tipo="moto">üèçÔ∏è</button>
    </div>
    <button id="btn-entrada">ENTRADA</button>
  </div>

  <div class="bottom-panel">
    <div class="header-row">
      <h3>ESTACIONADOS</h3>
      <span class="count" id="count">0</span>
    </div>
    <input type="text" id="searchInput" placeholder="BUSCAR PATENTE">
    <button id="clearFilterBtn">BORRAR FILTRO</button>
    <ul id="listaEstacionados"></ul>
  </div>

  <div id="toast" class="toast"></div>

  <script type="module">
    import { addEntrada, onEstacionados, removeEstacionado } from './firebase.js';

    const inputPatente=document.getElementById('placa');
    const inputNotas=document.getElementById('notas');
    const inputHora=document.getElementById('entryTime');
    const btnEntrada=document.getElementById('btn-entrada');
    const lista=document.getElementById('listaEstacionados');
    const countEl=document.getElementById('count');
    const searchInput=document.getElementById('searchInput');
    const clearBtn=document.getElementById('clearFilterBtn');
    let tipoSeleccionado='auto';
    document.querySelectorAll('[data-tipo]').forEach(b=>{
      b.addEventListener('click',()=>{
        document.querySelectorAll('[data-tipo]').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');tipoSeleccionado=b.dataset.tipo;
      });
    });

    function updateEntryTime(){inputHora.value=new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit',hour12:false});}
    updateEntryTime();setInterval(updateEntryTime,60000);
    function toast(m){const t=document.getElementById('toast');t.textContent=m;t.className='toast show';setTimeout(()=>t.className='toast',1800);}

    btnEntrada.addEventListener('click',async e=>{
      e.preventDefault();
      const placa=(inputPatente.value||'').trim().toUpperCase();
      if(!placa){toast('Ingres√° la patente');inputPatente.focus();return;}
      const d=new Date();
      await addEntrada({placa,tipo:tipoSeleccionado,notas:inputNotas.value||'',entradaISO:d.toISOString(),horaTexto:d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})});
      inputPatente.value='';inputNotas.value='';inputPatente.focus();toast('Veh√≠culo ingresado');
    });

    let cache=[];
    onEstacionados(items=>{cache=items||[];render();});
    function render(){
      const term=(searchInput.value||'').trim().toUpperCase();
      const filtered=term?cache.filter(v=>(v.placa||'').toUpperCase().includes(term)):cache;
      lista.innerHTML='';countEl.textContent=cache.length;
      clearBtn.classList.toggle('active',term.length>0);
      filtered.forEach(v=>{
        const li=document.createElement('li');
        const left=document.createElement('div');
        const emoji=v.tipo==='camioneta'?'üöê':(v.tipo==='moto'?'üèçÔ∏è':'üöó');
        left.innerHTML=`<span class="plate">${emoji} ${v.placa}</span><span class="time">${new Date(v.entradaISO).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})} hs.</span>`;
        const del=document.createElement('button');del.className='delete-btn';del.textContent='SALIDA';
        del.onclick=()=>removeEstacionado(v.id);
        li.append(left,del);
        lista.append(li);
      });
    }

    searchInput.addEventListener('input',render);
    clearBtn.addEventListener('click',()=>{searchInput.value='';render();});
  </script>
</body>
</html>
