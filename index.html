<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Estacionamiento</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-database.js"></script>
    <style>
        /* [El CSS permanece igual que la √∫ltima versi√≥n m√≥vil, lo omito para brevedad, pero aseg√∫rate de copiarlo desde tu archivo actual] */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                max-width: 100%;
                margin: 0;
                border-radius: 0;
            }
            .form-section, .list-section {
                width: 100%;
                padding: 10px;
            }
            .form-section {
                border-radius: 0;
            }
            .list-section {
                border-radius: 0;
            }
            .ingreso input#placa {
                font-size: 1em;
            }
            button {
                font-size: 1em;
                padding: 10px;
            }
            .vehicle-btn {
                font-size: 18px;
                padding: 6px;
            }
            .delete-btn {
                font-size: 14px;
                padding: 4px 10px;
            }
            .plate {
                font-size: 1.2em;
            }
            .time {
                font-size: 0.7em;
            }
            .note {
                font-size: 0.6em;
            }
            .modal-content {
                width: 85%;
                max-width: 350px;
                padding: 15px;
            }
            .modal-content h3 {
                font-size: 1.5em;
            }
            .modal-content .amount {
                font-size: 1.5em;
            }
            .theme-config {
                top: 5px;
                right: 5px;
            }
            .config-link {
                font-size: 10px;
                padding: 4px 8px;
            }
            .theme-toggle {
                width: 30px;
                height: 30px;
                font-size: 16px;
            }
        }
        /* Resto del CSS (copia desde tu versi√≥n actual) */
    </style>
</head>
<body>
    <div class="theme-config">
        <a href="config.html" class="config-link" target="_blank">Configuraci√≥n</a>
        <button class="theme-toggle" onclick="toggleTheme()">üåû</button>
    </div>
    <div class="container">
        <div class="form-section">
            <section class="ingreso">
                <h2>INGRESO DE VEH√çCULO</h2>
                <input type="text" id="placa" placeholder="Patente" list="placaSuggestions" autocomplete="off">
                <input type="text" id="entryTime" value="" readonly>
                <datalist id="placaSuggestions"></datalist>
                <input type="text" id="notas" placeholder="Notas">
                <div class="vehicle-buttons">
                    <button id="autoBtn" class="vehicle-btn active">üöó</button>
                    <button id="camionetaBtn" class="vehicle-btn">üöê</button>
                    <button id="motoBtn" class="vehicle-btn">üèçÔ∏è</button>
                </div>
                <button onclick="ingresarVehiculo()">ENTRADA</button>
            </section>
        </div>
        <div class="list-section">
            <h2>ESTACIONADOS: <span id="count">0</span></h2>
            <input type="text" id="searchInput" placeholder="Buscar placa...">
            <button id="clearFilterBtn" class="clear-filter-btn">Borrar filtro</button>
            <div class="table-header"></div>
            <ul id="listaEstacionados"></ul>
        </div>
    </div>

    <!-- Modal para salida de veh√≠culo -->
    <div id="exitModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="document.getElementById('exitModal').style.display='none'">&times;</span>
            <h3 id="exitTitle"></h3>
            <p id="exitInfo"></p>
            <p class="amount" id="exitAmount"></p>
            <input type="number" id="paymentInput" placeholder="Monto pagado ($)" oninput="calculateChange()">
            <p class="change" id="changeOutput">Vuelto: $0</p>
            <button id="confirmButton" onclick="confirmExit()">Confirmar</button>
        </div>
    </div>

    <!-- Toast para feedback visual -->
    <div id="toast" class="toast"></div>

    <script>
        console.log('Script cargado');

        // Tu configuraci√≥n de Firebase (reemplaza con la tuya)
        const firebaseConfig = {
            apiKey: "TU_CLAVE_API",
            authDomain: "TU_DOMINIO_AUTH",
            databaseURL: "TU_URL_BASE_DATOS",
            projectId: "TU_ID_PROYECTO",
            storageBucket: "TU_CUBO_ALMACENAMIENTO",
            messagingSenderId: "TU_ID_ENVIO_MENSAJES",
            appId: "TU_ID_APP"
        };

        // Inicializa Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const estacionadosRef = database.ref('estacionados');

        let tarifas = JSON.parse(localStorage.getItem('tarifas')) || { auto: 5, moto: 3, camioneta: 7 };
        let selectedType = 'auto'; // Por defecto, Auto est√° preseleccionado
        let estacionados = []; // Se cargar√° desde Firebase

        // Lista de placas frecuentes (puedes personalizarla)
        let frequentPlates = ['GG 123 HJ', 'HH 456 KL', 'JJ 789 MN'];

        // Cargar tema desde localStorage o usar modo claro por defecto
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-mode');
            document.querySelector('.theme-toggle').textContent = 'üåô';
        }

        let currentExitIndex = -1;
        let cobro = 0;

        // Cargar datos desde Firebase al iniciar
        estacionadosRef.on('value', (snapshot) => {
            estacionados = snapshot.val() ? Object.values(snapshot.val()) : [];
            renderizarListas();
            updateSuggestions();
        });

        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.querySelector('.theme-toggle');
            const container = document.querySelector('.container');
            const formSection = document.querySelector('.form-section');
            const listSection = document.querySelector('.list-section');
            const inputs = document.querySelectorAll('input, select');
            const vehicleButtons = document.querySelectorAll('.vehicle-btn');
            const deleteButtons = document.querySelectorAll('.delete-btn');
            const clearFilterBtn = document.querySelector('.clear-filter-btn');
            const lis = document.querySelectorAll('li');
            const modalContent = document.querySelector('.modal-content');

            if (body.classList.contains('dark-mode')) {
                body.classList.remove('dark-mode');
                themeToggle.textContent = 'üåû';
                container.classList.remove('dark-mode');
                formSection.classList.remove('dark-mode');
                listSection.classList.remove('dark-mode');
                inputs.forEach(input => input.classList.remove('dark-mode'));
                vehicleButtons.forEach(btn => btn.classList.remove('dark-mode'));
                deleteButtons.forEach(btn => btn.classList.remove('dark-mode'));
                clearFilterBtn.classList.remove('dark-mode');
                lis.forEach(li => li.classList.remove('dark-mode'));
                if (modalContent) modalContent.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
            } else {
                body.classList.add('dark-mode');
                themeToggle.textContent = 'üåô';
                container.classList.add('dark-mode');
                formSection.classList.add('dark-mode');
                listSection.classList.add('dark-mode');
                inputs.forEach(input => input.classList.add('dark-mode'));
                vehicleButtons.forEach(btn => btn.classList.add('dark-mode'));
                deleteButtons.forEach(btn => btn.classList.add('dark-mode'));
                clearFilterBtn.classList.add('dark-mode');
                lis.forEach(li => li.classList.add('dark-mode'));
                if (modalContent) modalContent.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
            }
            renderizarListas();
            updateSuggestions();
        }

        function ingresarVehiculo() {
            console.log('Intentando ingresar veh√≠culo');
            const placaInput = document.getElementById('placa');
            const notasInput = document.getElementById('notas');
            const entryTimeInput = document.getElementById('entryTime');

            if (!placaInput || !notasInput || !entryTimeInput) {
                console.log('Error: Elementos no encontrados', { placaInput, notasInput, entryTimeInput });
                return;
            }

            const placa = placaInput.value.trim().toUpperCase();
            const notas = notasInput.value.trim();
            const tipo = selectedType;
            const entrada = new Date().toISOString();
            const hora = entryTimeInput.value;

            console.log('Datos ingresados:', { placa, notas, tipo, hora });

            if (placa === '') {
                alert('Por favor, ingresa una patente v√°lida');
                return;
            }

            if (estacionados.some(v => v.placa === placa)) {
                alert('Este veh√≠culo ya est√° estacionado');
                return;
            }

            const vehiculo = {
                placa,
                notas,
                tipo,
                entrada,
                hora,
                estado: 'E'
            };

            estacionadosRef.push(vehiculo); // Guardar en Firebase
            showToast('Veh√≠culo ingresado');

            selectedType = 'auto';
            document.getElementById('autoBtn').classList.add('active');
            document.getElementById('camionetaBtn').classList.remove('active');
            document.getElementById('motoBtn').classList.remove('active');
            placaInput.value = '';
            notasInput.value = '';
            console.log('Veh√≠culo ingresado:', vehiculo);
        }

        function salidaVehiculo(index) {
            const vehiculo = estacionados[index];
            const salida = new Date();
            const entrada = new Date(vehiculo.entrada);

            const tiempoMinutos = Math.ceil((salida - entrada) / (1000 * 60));
            const horasCompletas = Math.floor(tiempoMinutos / 60);
            const minutosRestantes = tiempoMinutos % 60;
            const tarifaHora = tarifas[vehiculo.tipo];

            let cobroTotal = tarifaHora;
            if (horasCompletas > 0) {
                cobroTotal += (horasCompletas - 1) * tarifaHora;
            }
            const fracciones30min = Math.floor(minutosRestantes / 30);
            cobroTotal += fracciones30min * (tarifaHora / 2);

            cobro = cobroTotal;

            currentExitIndex = index;
            document.getElementById('exitTitle').textContent = vehiculo.placa.toUpperCase();
            document.getElementById('exitInfo').innerHTML = `Entrada: ${new Date(vehiculo.entrada).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false })} hs.<br>Salida: ${salida.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false })} hs.<br>Tiempo: ${tiempoMinutos} minutos`;
            document.getElementById('exitAmount').textContent = `$${cobro}`;
            document.getElementById('paymentInput').value = '';
            document.getElementById('changeOutput').textContent = 'Vuelto: $0';
            document.getElementById('exitModal').style.display = 'flex';
            if (document.body.classList.contains('dark-mode')) {
                document.getElementById('exitModal').querySelector('.modal-content').classList.add('dark-mode');
            }
            showToast('Salida confirmada');

            document.addEventListener('keydown', handleModalKeyPress);
        }

        function calculateChange() {
            const payment = parseFloat(document.getElementById('paymentInput').value) || 0;
            const change = payment - cobro;
            document.getElementById('changeOutput').textContent = `Vuelto: $${change >= 0 ? change : 'Pago insuficiente'}`;
        }

        function confirmExit() {
            const payment = parseFloat(document.getElementById('paymentInput').value) || 0;
            if (payment >= cobro || payment === 0) {
                estacionadosRef.child(Object.keys(estacionados)[currentExitIndex]).remove();
                renderizarListas();
                document.getElementById('exitModal').style.display = 'none';
                currentExitIndex = -1;
                document.removeEventListener('keydown', handleModalKeyPress);
            } else {
                alert('Pago insuficiente. Por favor, ingrese un monto mayor o igual al cobro.');
            }
        }

        function handleModalKeyPress(event) {
            if (document.getElementById('exitModal').style.display === 'flex') {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    document.getElementById('confirmButton').click();
                } else if (event.key === 'Escape') {
                    event.preventDefault();
                    document.getElementById('exitModal').style.display = 'none';
                    document.removeEventListener('keydown', handleModalKeyPress);
                }
            }
        }

        function renderizarListas() {
            const listaEstacionados = document.getElementById('listaEstacionados');
            const count = document.getElementById('count');
            const searchInput = document.getElementById('searchInput');
            const clearFilterBtn = document.getElementById('clearFilterBtn');

            if (!listaEstacionados || !count || !searchInput || !clearFilterBtn) {
                console.log('Error: Elementos no encontrados');
                return;
            }

            const searchTerm = searchInput.value.trim().toUpperCase();
            listaEstacionados.innerHTML = '';
            count.textContent = estacionados.length;

            clearFilterBtn.classList.toggle('active', searchTerm !== '');

            const filteredEstacionados = searchTerm === ''
                ? estacionados
                : estacionados.filter(v => v.placa.includes(searchTerm));

            filteredEstacionados.forEach((v, index) => {
                const li = document.createElement('li');
                li.className = v.estado === 'E' ? 'in-parking' : 'used';
                if (document.body.classList.contains('dark-mode')) li.classList.add('dark-mode');
                const plateSpan = document.createElement('span');
                plateSpan.className = 'plate';
                if (document.body.classList.contains('dark-mode')) plateSpan.classList.add('dark-mode');
                let emoji = '';
                if (v.tipo === 'auto') emoji = 'üöó ';
                else if (v.tipo === 'camioneta') emoji = 'üöê ';
                else if (v.tipo === 'moto') emoji = 'üèçÔ∏è ';
                plateSpan.textContent = emoji + v.placa;
                const timeSpan = document.createElement('span');
                timeSpan.className = 'time';
                if (document.body.classList.contains('dark-mode')) timeSpan.classList.add('dark-mode');
                timeSpan.textContent = v.hora;
                const noteSpan = v.notas ? document.createElement('span') : null;
                if (noteSpan) {
                    noteSpan.className = 'note';
                    if (document.body.classList.contains('dark-mode')) noteSpan.classList.add('dark-mode');
                    noteSpan.textContent = v.notas;
                }
                const div = document.createElement('div');
                div.appendChild(plateSpan);
                div.appendChild(timeSpan);
                if (noteSpan) div.appendChild(noteSpan);
                const deleteButton = document.createElement('button');
                deleteButton.className = 'delete-btn';
                deleteButton.textContent = 'SALIDA';
                deleteButton.onclick = () => salidaVehiculo(index);
                li.appendChild(div);
                li.appendChild(deleteButton);
                listaEstacionados.appendChild(li);
            });
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show';
            setTimeout(() => {
                toast.className = 'toast';
            }, 2000);
        }

        function updateSuggestions() {
            const datalist = document.getElementById('placaSuggestions');
            datalist.innerHTML = '';
            const uniquePlates = [...new Set(estacionados.map(v => v.placa))].slice(0, 5);
            uniquePlates.forEach(placa => {
                const option = document.createElement('option');
                option.value = placa;
                datalist.appendChild(option);
            });
            frequentPlates.forEach(placa => {
                if (!uniquePlates.includes(placa)) {
                    const option = document.createElement('option');
                    option.value = placa;
                    datalist.appendChild(option);
                }
            });
        }

        function updateEntryTime() {
            const entryTimeInput = document.getElementById('entryTime');
            const now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
            entryTimeInput.value = now;
        }
        setInterval(updateEntryTime, 60000);
        updateEntryTime();

        window.onload = function() {
            renderizarListas();
            updateSuggestions();
            const searchInput = document.getElementById('searchInput');
            const clearFilterBtn = document.getElementById('clearFilterBtn');
            const autoBtn = document.getElementById('autoBtn');
            const camionetaBtn = document.getElementById('camionetaBtn');
            const motoBtn = document.getElementById('motoBtn');

            searchInput.addEventListener('input', renderizarListas);
            clearFilterBtn.addEventListener('click', function() {
                searchInput.value = '';
                renderizarListas();
            });

            const placaInput = document.getElementById('placa');
            placaInput.addEventListener('input', updateSuggestions);
            placaInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    ingresarVehiculo();
                }
            });

            autoBtn.addEventListener('click', function() {
                selectedType = 'auto';
                autoBtn.classList.add('active');
                camionetaBtn.classList.remove('active');
                motoBtn.classList.remove('active');
            });

            camionetaBtn.addEventListener('click', function() {
                selectedType = 'camioneta';
                camionetaBtn.classList.add('active');
                autoBtn.classList.remove('active');
                motoBtn.classList.remove('active');
            });

            motoBtn.addEventListener('click', function() {
                selectedType = 'moto';
                motoBtn.classList.add('active');
                autoBtn.classList.remove('active');
                camionetaBtn.classList.remove('active');
            });
        };
    </script>
</body>
</html>
