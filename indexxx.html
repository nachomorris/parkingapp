<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Estadísticas — Horarios Populares</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet"/>
  <style>
    *{box-sizing:border-box} body{font-family:Roboto,system-ui,-apple-system,sans-serif;background:#f5f7fa;color:#223; margin:0; padding:12px}
    .wrap{max-width:1000px;margin:0 auto;background:#fff;border:1px solid #e6eaf0;border-radius:16px;box-shadow:0 8px 24px rgba(18,33,61,.06);overflow:hidden}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid #eef2f7;background:#fafcff}
    h1{font-size:1.25rem;margin:0}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    select,button{padding:8px 10px;border:1px solid #d7dde3;border-radius:10px;background:#fff;font-weight:700;color:#415466;cursor:pointer}
    .badge-live{display:inline-block;background:#e83f3f;color:#fff;font-weight:800;letter-spacing:.02em;padding:4px 8px;border-radius:8px;margin-right:8px;font-size:.8rem}
    .muted{color:#6c7a8a;font-weight:700}
    main{padding:16px 18px}

    /* Chart */
    .chart{display:grid;grid-template-columns:repeat(24,1fr);gap:6px;align-items:end;height:220px;padding:18px 8px 10px;border-bottom:1px dashed #e6eaf0}
    .bar{position:relative;background:#5b8aa6;border-radius:8px 8px 0 0;height:0;transition:height .4s}
    .bar.live{outline:2px solid #f16363; background:#c65c5c}
    .bar:hover::after{content:attr(data-tip);position:absolute;left:50%;transform:translateX(-50%);bottom:100%;margin-bottom:8px;background:#1f2a36;color:#fff;padding:6px 8px;border-radius:6px;font-size:.75rem;white-space:nowrap}
    .xlabels{display:grid;grid-template-columns:repeat(24,1fr);gap:6px;margin-top:8px;font-size:.78rem;color:#6c7a8a}
    .xlabels span{justify-self:center}

    /* KPIs */
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:16px}
    .kpi{border:1px solid #eef2f7;border-left:4px solid #2f7ad6;border-radius:12px;background:#fbfdff;padding:12px}
    .kpi h4{margin:0 0 6px 0;color:#6c7a8a;font-size:.85rem;text-transform:uppercase;letter-spacing:.02em}
    .kpi .v{font-weight:800;font-size:1.25rem;color:#1f2a36}

    footer{padding:14px 18px;color:#6c7a8a;font-size:.85rem}

    @media (max-width:900px){ .chart{grid-template-columns:repeat(12,1fr)} .xlabels{grid-template-columns:repeat(12,1fr)} .h24{display:none} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Horarios de mayor concurrencia</h1>
      <div class="controls">
        <label class="muted">Día</label>
        <select id="daySelect">
          <option value="0">domingo</option>
          <option value="1">lunes</option>
          <option value="2">martes</option>
          <option value="3">miércoles</option>
          <option value="4">jueves</option>
          <option value="5">viernes</option>
          <option value="6">sábado</option>
        </select>
        <label class="muted">Rango</label>
        <select id="rangeSelect">
          <option value="7">Últimos 7 días</option>
          <option value="30" selected>Últimos 30 días</option>
          <option value="90">Últimos 90 días</option>
        </select>
      </div>
    </header>

    <main>
      <div style="margin-bottom:8px;">
        <span class="badge-live">EN TIEMPO REAL</span>
        <span id="liveText" class="muted">Calculando…</span>
      </div>

      <div id="chart" class="chart" aria-label="Promedio de ocupación por hora"></div>
      <div class="xlabels" id="xlabels"></div>

      <section class="kpis">
        <div class="kpi"><h4>Pico promedio del día</h4><div class="v" id="kpiPeak">–</div></div>
        <div class="kpi"><h4>Ocupación ahora</h4><div class="v" id="kpiNow">–</div></div>
        <div class="kpi"><h4>Vehículos hoy</h4><div class="v" id="kpiToday">–</div></div>
      </section>
    </main>

    <footer>Basado en entradas y salidas históricas (n = <span id="sampleSize">0</span> días del día seleccionado). Promedio en “vehículos concurrentes”.</footer>
  </div>

  <script type="module">
    /* Firebase */
    import { app } from './firebase.js';
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-database.js";
    import { onEstacionados } from './firebase.js';
    const db = getDatabase(app);

    /* UI refs */
    const daySelect   = document.getElementById('daySelect');
    const rangeSelect = document.getElementById('rangeSelect');
    const chartEl     = document.getElementById('chart');
    const xlabelsEl   = document.getElementById('xlabels');
    const liveText    = document.getElementById('liveText');
    const kpiPeak     = document.getElementById('kpiPeak');
    const kpiNow      = document.getElementById('kpiNow');
    const kpiToday    = document.getElementById('kpiToday');
    const sampleSize  = document.getElementById('sampleSize');

    /* Helpers */
    const HRS = Array.from({length:24},(_,h)=>h);
    function pad2(n){ return String(n).padStart(2,'0'); }
    function labelForHour(h){
      const ampm = h===0? "12 a. m.": (h<12? h+" a. m.": (h===12? "12 p. m.": (h-12)+" p. m."));
      return ampm;
    }
    function overlapMinutes(aStart,aEnd,bStart,bEnd){
      const start = Math.max(aStart,bStart), end = Math.min(aEnd,bEnd);
      return Math.max(0, Math.ceil((end - start)/60000));
    }
    function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
    function endOfDay(d){ const x=new Date(d); x.setHours(23,59,59,999); return x; }

    /* Axis labels */
    xlabelsEl.innerHTML = HRS.map(h=>`<span class="${(h%2)?'h24':''}">${labelForHour(h)}</span>`).join('');

    /* State */
    let historial = []; // [{entradaISO, salidaISO, tipo, placa}]
    let estacionadosAhora = 0;

    // Live estacionados (para “ahora”)
    onEstacionados(items => {
      estacionadosAhora = (items||[]).length;
      renderNow();
    });

    // Cargar histórico de /salidas (stream)
    onValue(ref(db,'salidas'), snap => {
      const val = snap.val() || {};
      historial = Object.values(val).filter(x=>x.entradaISO && x.salidaISO);
      renderAll();
    });

    // UI events
    daySelect.value = String(new Date().getDay()); // default: hoy
    daySelect.addEventListener('change', renderAll);
    rangeSelect.addEventListener('change', renderAll);

    function renderAll(){
      const day = parseInt(daySelect.value,10);
      const daysBack = parseInt(rangeSelect.value,10);
      const today = new Date();
      const from = new Date(); from.setDate(today.getDate()-daysBack+1); from.setHours(0,0,0,0);

      // Filtrar registros dentro del rango
      const rows = historial.filter(r=>{
        const end = new Date(r.salidaISO);
        return end >= from && end <= today;
      });

      // Encontrar qué días del rango coinciden con ese día de semana (para dividir el promedio)
      let sampleDays = 0;
      for(let d = startOfDay(from); d <= today; d = new Date(d.getTime()+86400000)){
        if (d.getDay() === day) sampleDays++;
      }
      sampleSize.textContent = sampleDays;

      // Buckets en minutos por hora (24)
      const minutesPerHour = new Array(24).fill(0);

      // Sumar “vehículo-minutos” cuando el intervalo solapa cada hora del día SELECCIONADO
      rows.forEach(r=>{
        const inD  = new Date(r.entradaISO);
        const outD = new Date(r.salidaISO);
        // iteramos por cada día in-between que tenga el weekday == day
        for(let d = startOfDay(inD); d <= endOfDay(outD); d = new Date(d.getTime()+86400000)){
          if (d.getDay() !== day) continue;
          // intervalo de ese día:
          const dayStart = startOfDay(d).getTime();
          const dayEnd   = endOfDay(d).getTime();
          const segStart = Math.max(inD.getTime(), dayStart);
          const segEnd   = Math.min(outD.getTime(), dayEnd);
          if (segEnd <= segStart) continue;

          // por cada hora del 0..23 sumo los minutos solapados
          for(let h=0; h<24; h++){
            const hStart = dayStart + h*3600000;
            const hEnd   = hStart + 3600000;
            const mins = overlapMinutes(segStart, segEnd, hStart, hEnd);
            if (mins>0) minutesPerHour[h] += mins;
          }
        }
      });

      // Convertir a “vehículos concurrentes promedio” = minutos acumulados / (60 * sampleDays)
      const avgOcc = minutesPerHour.map(mins => sampleDays ? (mins / (60*sampleDays)) : 0);

      renderChart(avgOcc);
      renderKPIs(avgOcc);
      renderNow(avgOcc);
    }

    function renderChart(values){
      const max = Math.max(1, ...values);
      chartEl.innerHTML = '';
      values.forEach((v,h)=>{
        const pct = (v/max)*100;
        const div = document.createElement('div');
        div.className = 'bar';
        if (h === new Date().getHours()) div.classList.add('live');
        div.style.height = (pct*0.94 + 2) + '%'; // 2% piso visual
        div.dataset.tip = `${labelForHour(h)} · ${v.toFixed(1)} veh`;
        chartEl.appendChild(div);
      });
    }

    function renderKPIs(values=[]){
      const peakVal = Math.max(0, ...values);
      const peakHr  = values.findIndex(v=>v===peakVal);
      kpiPeak.textContent = peakVal ? `${labelForHour(peakHr)} · ${peakVal.toFixed(1)} veh` : '–';
      kpiToday.textContent = countSalidasHoy();
    }

    function countSalidasHoy(){
      const today = new Date();
      const s0 = startOfDay(today).getTime(), s1 = endOfDay(today).getTime();
      return historial.filter(x=>{
        const t = new Date(x.salidaISO).getTime();
        return t>=s0 && t<=s1;
      }).length;
    }

    function renderNow(values=[]){
      // Mostrar estacionados ahora y semáforo textual vs pico del día seleccionado
      kpiNow.textContent = `${estacionadosAhora} veh`;
      const peak = values.length ? Math.max(1, ...values) : Math.max(1, estacionadosAhora);
      const ratio = estacionadosAhora / peak;
      const txt =
        ratio < 0.4 ? 'Poco concurrido' :
        ratio < 0.7 ? 'Moderado' :
                      'Muy concurrido';
      liveText.textContent = txt;
      // también remarco la barra de la hora actual si el chart existe
      [...chartEl.children].forEach((b,i)=> b.classList.toggle('live', i===new Date().getHours()));
    }
  </script>
</body>
</html>
